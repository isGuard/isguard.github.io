<!DOCTYPE html><html lang="zh-CN" data-theme="dark"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"><title>通过fail2ban服务监控frps日志实现禁止非法IP | zea</title><meta name="author" content="初。"><meta name="copyright" content="初。"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#0d0d0d"><meta name="description" content="通过fail2ban服务监控frps日志实现禁止非法IP前言服务器使用了frp作为了内网穿透软件，查看frps的日志，发现总有一些国外的ip在扫描这台服务器的端口信息，日志如下图，所以想通过fail2ban服务能够直接禁用这些ip扫描服务器。"><meta property="og:type" content="article"><meta property="og:title" content="通过fail2ban服务监控frps日志实现禁止非法IP"><meta property="og:url" content="https://blog.48626.xyz/da0034a8ed0b.html"><meta property="og:site_name" content="zea"><meta property="og:description" content="通过fail2ban服务监控frps日志实现禁止非法IP前言服务器使用了frp作为了内网穿透软件，查看frps的日志，发现总有一些国外的ip在扫描这台服务器的端口信息，日志如下图，所以想通过fail2ban服务能够直接禁用这些ip扫描服务器。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://q1.qlogo.cn/g?b=qq&nk=770600073&s=640"><meta property="article:published_time" content="2024-07-03T08:40:03.000Z"><meta property="article:modified_time" content="2024-07-03T08:40:03.000Z"><meta property="article:author" content="初。"><meta property="article:tag" content="Linux"><meta property="article:tag" content="fail2ban"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://q1.qlogo.cn/g?b=qq&nk=770600073&s=640"><link rel="shortcut icon" href="/static/favicon.png"><link rel="canonical" href="https://blog.48626.xyz/da0034a8ed0b.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//www.google-analytics.com" crossorigin=""><link rel="preconnect" href="//hm.baidu.com"><link rel="preconnect" href="//www.clarity.ms"><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="google-site-verification" content="IRx06tBaTglUq66WChYv9bkH8lKr7PO60mUioFn--yM"><meta name="bing-site-verification" content="E4B8BD2F04290DD88CD9F8BF5853705F"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload='this.media="all"'><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?6558e13fa8bf20edf22ca260ae572e44";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><script async="async" src="https://www.googletagmanager.com/gtag/js?id=G-NRQETXBKL4"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-NRQETXBKL4")</script><script>!function(t,e,n,c,a,i,r){t[n]=t[n]||function(){(t[n].q=t[n].q||[]).push(arguments)},(i=e.createElement(c)).async=1,i.src="https://www.clarity.ms/tag/n2i82v50oq",(r=e.getElementsByTagName(c)[0]).parentNode.insertBefore(i,r)}(window,document,"clarity","script")</script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":true,"top_n_per_article":1,"unescape":true,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: {"limitCount":50,"languages":{"author":"作者: 初。","link":"链接: ","source":"来源: zea","info":"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"通过fail2ban服务监控frps日志实现禁止非法IP",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2024-07-03 16:40:03"}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="zea" type="application/atom+xml"></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://q1.qlogo.cn/g?b=qq&amp;nk=770600073&amp;s=640" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">153</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">52</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/menu/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/menu/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i> <span>插件</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/menu/plugins/aria2/"><i class="fa-fw fas fa-download"></i> <span>Aria2</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/menu/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>时间轴</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="not-top-img" id="page-header"><nav id="nav"><span id="blog-info"><a href="/" title="zea"><span class="site-name">zea</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>首页</span></a></div><div class="menus_item"><a class="site-page" href="/menu/tags/"><i class="fa-fw fas fa-tags"></i> <span>标签</span></a></div><div class="menus_item"><a class="site-page" href="/menu/categories/"><i class="fa-fw fas fa-folder-open"></i> <span>分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i> <span>插件</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/menu/plugins/aria2/"><i class="fa-fw fas fa-download"></i> <span>Aria2</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/menu/link/"><i class="fa-fw fas fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i> <span>时间轴</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav></header><main class="layout" id="content-inner"><div id="post"><div id="post-info"><h1 class="post-title">通过fail2ban服务监控frps日志实现禁止非法IP</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-03T08:40:03.000Z" title="发表于 2024-07-03 16:40:03">2024-07-03</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-03T08:40:03.000Z" title="更新于 2024-07-03 16:40:03">2024-07-03</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/">Linux</a><i class="fas fa-angle-right post-meta-separator"></i><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Linux/fail2ban/">fail2ban</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">1.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>5分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="通过fail2ban服务监控frps日志实现禁止非法IP"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div><article class="post-content" id="article-container"><h2 id="通过fail2ban服务监控frps日志实现禁止非法IP"><a href="#通过fail2ban服务监控frps日志实现禁止非法IP" class="headerlink" title="通过fail2ban服务监控frps日志实现禁止非法IP"></a>通过fail2ban服务监控frps日志实现禁止非法IP</h2><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>服务器使用了frp作为了内网穿透软件，查看frps的日志，发现总有一些国外的ip在扫描这台服务器的端口信息，日志如下图，所以想通过fail2ban服务能够直接禁用这些ip扫描服务器。</p><p>注意一定要挂载日志文件</p><h3 id="1、安装fail2ban服务"><a href="#1、安装fail2ban服务" class="headerlink" title="1、安装fail2ban服务"></a>1、安装fail2ban服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y fail2ban</span><br></pre></td></tr></table></figure><h3 id="2、设置查找frps的规则"><a href="#2、设置查找frps的规则" class="headerlink" title="2、设置查找frps的规则"></a>2、设置查找frps的规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@lianhe ~]<span class="comment"># cat /etc/fail2ban/filter.d/frps.conf</span></span><br><span class="line">[Definition]</span><br><span class="line">failregex = ^.*get a user connection \[&lt;HOST&gt;:[0-9]*\]</span><br><span class="line">            ^.*get a new work connection: \[&lt;HOST&gt;:[0-9]*\]</span><br><span class="line">ignoreregex =</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用gpt4生成的规则</span></span><br><span class="line">[Definition]</span><br><span class="line">failregex = ^.*auth failed.*ip:&lt;HOST&gt;.*$</span><br><span class="line">            ^.*illegal connection.*ip:&lt;HOST&gt;.*$</span><br><span class="line">ignoreregex =</span><br></pre></td></tr></table></figure><h3 id="3、校验规则"><a href="#3、校验规则" class="headerlink" title="3、校验规则"></a>3、校验规则</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fail2ban-regex /opt/1panel/apps/frps/frps/log/frps.log /etc/fail2ban/filter.d/frps.conf</span><br></pre></td></tr></table></figure><h3 id="4、设置发现frps的异常ip的操作"><a href="#4、设置发现frps的异常ip的操作" class="headerlink" title="4、设置发现frps的异常ip的操作"></a>4、设置发现frps的异常ip的操作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入fail2ban目录，copy一份配置文件</span></span><br><span class="line">[root@lianhe fail2ban]<span class="comment">#  cp jail.conf  jail.local</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 jail.local 下添加一下规则</span></span><br><span class="line">[frp]</span><br><span class="line">enabled = <span class="literal">true</span></span><br><span class="line">findtime = 600</span><br><span class="line">maxretry = 5</span><br><span class="line">bantime = -1</span><br><span class="line">filter = frps</span><br><span class="line">logpath = /opt/1panel/apps/frps/frps/frps.log</span><br><span class="line">protocol = all</span><br><span class="line">chain = all</span><br><span class="line">port = all</span><br><span class="line">action = iptables-allports[name=frp,protocol=tcp]</span><br></pre></td></tr></table></figure><p>配置说明<br>frp：监控目标名称<br>port：封禁全部端口<br>filter：过滤规则，我们使用自定义的frps<br>action：捕捉到恶意IP后执行的操作，本文使用iptables对IP封禁所有端口<br>logpath：需要监控的日志文件<br>bantime：封禁时间，单位为秒<br>findtime：查找时间段，单位为秒<br>maxretry：允许的最大失败次数，这里我们配置10分钟内触发10次规则，那么就封禁掉</p><h3 id="4、永久禁用ip地址"><a href="#4、永久禁用ip地址" class="headerlink" title="4、永久禁用ip地址"></a>4、永久禁用ip地址</h3><h4 id="4-1-编辑文件：-etc-fail2ban-jail-local"><a href="#4-1-编辑文件：-etc-fail2ban-jail-local" class="headerlink" title="4.1 编辑文件：&#x2F;etc&#x2F;fail2ban&#x2F;jail.local"></a>4.1 编辑文件：&#x2F;etc&#x2F;fail2ban&#x2F;jail.local</h4><p>在此件中查找banaction条目。以下屏幕截图显示禁止是iptables-multiport。</p><h4 id="4-2-编辑-banaction文件：-etc-fail2ban-action-d-iptables-multiport-conf"><a href="#4-2-编辑-banaction文件：-etc-fail2ban-action-d-iptables-multiport-conf" class="headerlink" title="4.2 编辑 banaction文件： &#x2F;etc&#x2F;fail2ban&#x2F;action.d&#x2F;iptables-multiport.conf"></a>4.2 编辑 banaction文件： &#x2F;etc&#x2F;fail2ban&#x2F;action.d&#x2F;iptables-multiport.conf</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在 actionstart 默认条目下，添加以下行：</span></span><br><span class="line"><span class="built_in">cat</span> /etc/fail2ban/ip.banned | <span class="keyword">while</span> <span class="built_in">read</span> IP; <span class="keyword">do</span> iptables -I fail2ban-&lt;name&gt; 1 -s <span class="variable">$IP</span> -j DROP; <span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 actionban 默认条目下，添加以下行：</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;&lt;ip&gt;&#x27;</span> &gt;&gt; /etc/fail2ban/ip.banned</span><br></pre></td></tr></table></figure><h3 id="5、fail2ban服务重新加载"><a href="#5、fail2ban服务重新加载" class="headerlink" title="5、fail2ban服务重新加载"></a>5、fail2ban服务重新加载</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fail2ban-client reload</span><br></pre></td></tr></table></figure><h3 id="6、查看frp服务器禁用那些ip"><a href="#6、查看frp服务器禁用那些ip" class="headerlink" title="6、查看frp服务器禁用那些ip"></a>6、查看frp服务器禁用那些ip</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@lianhe ~]<span class="comment"># fail2ban-client status frp</span></span><br><span class="line">Status <span class="keyword">for</span> the jail: frp</span><br><span class="line">|- Filter</span><br><span class="line">|  |- Currently failed:	21</span><br><span class="line">|  |- Total failed:	224</span><br><span class="line">|  `- File list:	/var/lib/docker/containers/ca21dd5be6d88edad61619d3c14366dda78858ee588c751714a0facc5e2c4985/ca21dd5be6d88edad61619d3c14366dda78858ee588c751714a0facc5e2c4985-json.log</span><br><span class="line">`- Actions</span><br><span class="line">   |- Currently banned:	32</span><br><span class="line">   |- Total banned:	32</span><br><span class="line">   `- Banned IP list:	118.113.244.254 87.120.84.35 172.104.238.212 162.215.216.231 107.173.211.107 61.140.220.92 218.19.45.23 219.152.231.118 168.76.123.59 45.183.247.34 103.164.216.221 162.241.69.208 185.137.122.180 162.62.218.43 124.152.99.57 45.88.90.55 103.154.184.109 87.107.190.12 87.107.190.59 94.156.8.86 119.28.118.4 59.13.123.99 101.126.69.60 124.156.204.21 68.66.251.162 58.210.241.5 103.78.12.14 35.200.157.232 43.153.176.71 91.92.245.192 171.106.204.37 108.179.217.143</span><br></pre></td></tr></table></figure><h3 id="7、通过iptables查看禁用ip"><a href="#7、通过iptables查看禁用ip" class="headerlink" title="7、通过iptables查看禁用ip"></a>7、通过iptables查看禁用ip</h3><h3 id="8、如果有误判的ip地址，解决方法"><a href="#8、如果有误判的ip地址，解决方法" class="headerlink" title="8、如果有误判的ip地址，解决方法"></a>8、如果有误判的ip地址，解决方法</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fail2ban-client <span class="built_in">set</span>  frps  unbanip [ip地址]</span><br></pre></td></tr></table></figure><h3 id="9、重装"><a href="#9、重装" class="headerlink" title="9、重装"></a>9、重装</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">service fail2ban stop</span><br><span class="line"><span class="built_in">rm</span> -r /etc/fail2ban/</span><br><span class="line">apt-get purge fail2ban</span><br><span class="line">apt-get install fail2ban</span><br></pre></td></tr></table></figure><h3 id="10、使用-Fail2ban-client-验证-Fail2ban-状态"><a href="#10、使用-Fail2ban-client-验证-Fail2ban-状态" class="headerlink" title="10、使用 Fail2ban-client 验证 Fail2ban 状态"></a>10、使用 Fail2ban-client 验证 Fail2ban 状态</h3><p>fail2ban 提供了一个命令行 fail2ban-client 用于与 Fail2ban 服务进行交互。这允许您从命令行管理和配置 Fail2ban，还允许您管理 Fail2ban 监狱。</p><p>要验证 fail2ban 安装和配置，请运行以下命令的 <em>fail2ban-client</em>。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client ping</span><br></pre></td></tr></table></figure><p>如果您收到诸如“服务器回复：pong”之类的输出消息，这意味着 Fail2ban 正在正常运行。</p><p>接下来，运行下面的 <em>fail2ban-client</em> 命令来检查 sshd jail 的状态。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client status sshd</span><br></pre></td></tr></table></figure><p>下面你可以看到 sshd jail 的详细状态。这包括 SSH 服务的日志文件和 sshd jail 上被禁止的 IP 地址列表。</p><p>现在如果你想获得 sshd 监狱的详细配置，你可以使用 fail2ban-client 命令如下。</p><p>检查 sshd jail 的 bantime 配置。您将在几秒钟内获得 bantime 的输出。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client get sshd bantime</span><br></pre></td></tr></table></figure><p>检查 sshd jail 的 maxrtey 配置。你会看到这里的 maxretry 是 3，因为它被全局配置覆盖了，也就是 maxrety 5 次。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client get sshd maxretry</span><br></pre></td></tr></table></figure><p>对于sshd jail中的banaction，可以使用以下命令。并且您应该将 ufw 的输出作为 sshd jail 的默认禁令。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client get sshd actions</span><br></pre></td></tr></table></figure><p>对于此处的查找时间，您还将看到 sshd 监狱的覆盖值。此处的输出也将采用秒格式。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client get sshd findtime</span><br></pre></td></tr></table></figure><p>最后，您还可以使用以下命令检查 sshd jail 的默认 ignoreip。你会看到 ignoreip 与全局 Fail2ban 配置具有相同的值。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client get sshd ignoreip</span><br></pre></td></tr></table></figure><h3 id="11、使用-Fail2ban-client-禁止和取消禁止-IP"><a href="#11、使用-Fail2ban-client-禁止和取消禁止-IP" class="headerlink" title="11、使用 Fail2ban-client 禁止和取消禁止 IP"></a>11、使用 Fail2ban-client 禁止和取消禁止 IP</h3><p>关于 Fail2ban 的另一个重要事项是如何在 Fail2ban 上禁止和取消禁止 IP 地址。为此，您还可以使用 fail2ban-client 命令。</p><p>要在 sshd jail 上手动禁止 IP 地址，您可以使用下面的 fail2ban-client 命令。将 IP 地址更改为您要禁止的 IP 地址。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client set sshd banip IP-ADDRESS</span><br></pre></td></tr></table></figure><p>要从 sshd jail 中解禁 IP 地址，您可以使用下面的 fail2ban-client 命令。请务必将 IP 地址更改为您要取消禁止的 IP 地址。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client set sshd unbanip IP-ADDRESS</span><br></pre></td></tr></table></figure><p>现在，在您手动禁止 IP 地址或取消禁止 IP 地址后，您可以使用下面的 fail2ban-client 命令进行验证。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fail2ban-client status sshd</span><br></pre></td></tr></table></figure><p>如果您手动禁止某个 IP 地址，请确保该 IP 地址在禁止 IP 地址列表中可用。但是，如果您取消禁止某个 IP 地址，请确保该 IP 地址从禁止 IP 地址列表中消失。</p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者:</span> <span class="post-copyright-info"><a href="https://blog.48626.xyz">初。</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接:</span> <span class="post-copyright-info"><a href="https://blog.48626.xyz/da0034a8ed0b.html">https://blog.48626.xyz/da0034a8ed0b.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://blog.48626.xyz" target="_blank">zea</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Linux/">Linux</a><a class="post-meta__tags" href="/tags/fail2ban/">fail2ban</a></div><div class="post_share"><div class="social-share" data-image="https://q1.qlogo.cn/g?b=qq&amp;nk=770600073&amp;s=640" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer="defer"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/7f8d325aadf0.html" title="Bilihepler-personal安装"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Bilihepler-personal安装</div></div></a></div><div class="next-post pull-right"><a href="/f2116e60767b.html" title="Frp穿透及防护"><div class="cover" style="background:var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Frp穿透及防护</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/949c2f6ddc37.html" title="Linux设置定时任务"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-07-03</div><div class="title">Linux设置定时任务</div></div></a></div><div><a href="/0f098a910aa5.html" title="SSH RCE 远程代码执行漏洞 POC"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-07-04</div><div class="title">SSH RCE 远程代码执行漏洞 POC</div></div></a></div><div><a href="/6ac9645de8fb.html" title="VMware虚拟机系统Ubuntu安装VMware tools工具"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-06</div><div class="title">VMware虚拟机系统Ubuntu安装VMware tools工具</div></div></a></div><div><a href="/393a7dbdc35f.html" title="修改Ubuntu分辨率"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-06</div><div class="title">修改Ubuntu分辨率</div></div></a></div><div><a href="/a832b0e518bd.html" title="修改Ubuntu的系统源"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-06</div><div class="title">修改Ubuntu的系统源</div></div></a></div><div><a href="/6d365f03d263.html" title="安装Ubuntu"><div class="cover" style="background:var(--default-bg-color)"></div><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2020-04-06</div><div class="title">安装Ubuntu</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://q1.qlogo.cn/g?b=qq&amp;nk=770600073&amp;s=640" onerror='this.onerror=null,this.src="/img/friend_404.gif"' alt="avatar"></div><div class="author-info__name">初。</div><div class="author-info__description">一个简单的博客</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">153</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">52</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">52</div></a></div><a id="card-info-btn" target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/isGuard"><i class="fab fa-github"></i><span>Github</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="https://github.com/isGuard" rel="external nofollow noreferrer" target="_blank" title="Github"><i class="fab fa-github" style="color:#24292e"></i></a><a class="social-icon" href="mailto:isguard@outlook.com" rel="external nofollow noreferrer" target="_blank" title="Email"><i class="fas fa-envelope" style="color:#24292e"></i></a><a class="social-icon" href="tencent://message/?uin=770600073&amp;Site=&amp;Menu=yes" rel="external nofollow noreferrer" target="_blank" title="QQ"><i class="fab fa-qq" style="color:#24292e"></i></a></div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87fail2ban%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7frps%E6%97%A5%E5%BF%97%E5%AE%9E%E7%8E%B0%E7%A6%81%E6%AD%A2%E9%9D%9E%E6%B3%95IP"><span class="toc-number">1.</span> <span class="toc-text">通过fail2ban服务监控frps日志实现禁止非法IP</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%89%8D%E8%A8%80"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81%E5%AE%89%E8%A3%85fail2ban%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.2.</span> <span class="toc-text">1、安装fail2ban服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E8%AE%BE%E7%BD%AE%E6%9F%A5%E6%89%BEfrps%E7%9A%84%E8%A7%84%E5%88%99"><span class="toc-number">1.3.</span> <span class="toc-text">2、设置查找frps的规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3%E3%80%81%E6%A0%A1%E9%AA%8C%E8%A7%84%E5%88%99"><span class="toc-number">1.4.</span> <span class="toc-text">3、校验规则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E8%AE%BE%E7%BD%AE%E5%8F%91%E7%8E%B0frps%E7%9A%84%E5%BC%82%E5%B8%B8ip%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.</span> <span class="toc-text">4、设置发现frps的异常ip的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4%E3%80%81%E6%B0%B8%E4%B9%85%E7%A6%81%E7%94%A8ip%E5%9C%B0%E5%9D%80"><span class="toc-number">1.6.</span> <span class="toc-text">4、永久禁用ip地址</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#4-1-%E7%BC%96%E8%BE%91%E6%96%87%E4%BB%B6%EF%BC%9A-etc-fail2ban-jail-local"><span class="toc-number">1.6.1.</span> <span class="toc-text">4.1 编辑文件：&#x2F;etc&#x2F;fail2ban&#x2F;jail.local</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-2-%E7%BC%96%E8%BE%91-banaction%E6%96%87%E4%BB%B6%EF%BC%9A-etc-fail2ban-action-d-iptables-multiport-conf"><span class="toc-number">1.6.2.</span> <span class="toc-text">4.2 编辑 banaction文件： &#x2F;etc&#x2F;fail2ban&#x2F;action.d&#x2F;iptables-multiport.conf</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5%E3%80%81fail2ban%E6%9C%8D%E5%8A%A1%E9%87%8D%E6%96%B0%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.7.</span> <span class="toc-text">5、fail2ban服务重新加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6%E3%80%81%E6%9F%A5%E7%9C%8Bfrp%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%A6%81%E7%94%A8%E9%82%A3%E4%BA%9Bip"><span class="toc-number">1.8.</span> <span class="toc-text">6、查看frp服务器禁用那些ip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7%E3%80%81%E9%80%9A%E8%BF%87iptables%E6%9F%A5%E7%9C%8B%E7%A6%81%E7%94%A8ip"><span class="toc-number">1.9.</span> <span class="toc-text">7、通过iptables查看禁用ip</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8%E3%80%81%E5%A6%82%E6%9E%9C%E6%9C%89%E8%AF%AF%E5%88%A4%E7%9A%84ip%E5%9C%B0%E5%9D%80%EF%BC%8C%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%95"><span class="toc-number">1.10.</span> <span class="toc-text">8、如果有误判的ip地址，解决方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9%E3%80%81%E9%87%8D%E8%A3%85"><span class="toc-number">1.11.</span> <span class="toc-text">9、重装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#10%E3%80%81%E4%BD%BF%E7%94%A8-Fail2ban-client-%E9%AA%8C%E8%AF%81-Fail2ban-%E7%8A%B6%E6%80%81"><span class="toc-number">1.12.</span> <span class="toc-text">10、使用 Fail2ban-client 验证 Fail2ban 状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#11%E3%80%81%E4%BD%BF%E7%94%A8-Fail2ban-client-%E7%A6%81%E6%AD%A2%E5%92%8C%E5%8F%96%E6%B6%88%E7%A6%81%E6%AD%A2-IP"><span class="toc-number">1.13.</span> <span class="toc-text">11、使用 Fail2ban-client 禁止和取消禁止 IP</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2016 - 2024 By 初。</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@5.2.0/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu@4.0.7/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div></body></html>